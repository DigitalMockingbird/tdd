<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Javascript Tests</title>
    <link rel="stylesheet" href="../../../superlists/static/tests/qunit-2.0.1.css">
</head>
<body>
<div id="qunit"></div>
<div id="qunit-fixture">
    <a href="" id="id_login">Sign in</a>
</div>

<script src="../../../superlists/static/js/jquery-3.1.1.min.js"></script>
<script src="../../../superlists/static/tests/qunit-2.0.1.js"></script>
<script src="../../../superlists/static/tests/sinon-1.17.6.js"></script>
<script src="../accounts.js"></script>
<script>
    QUnit.test("initialize binds sign in button to navigator.id.request", function (assert) {
        var requestWasCalled = false;
        var mockRequestFunction = function () {
            requestWasCalled = true;
        };
        var mockNavigator = {
            id: {
                request: mockRequestFunction,
                watch: function () {

                }
            }
        };

        Superlists.Accounts.initialize(mockNavigator);
        assert.equal(requestWasCalled, false, 'check request was not called before click');
        $('#id_login').trigger('click');
        assert.equal(requestWasCalled, true);
    });
    QUnit.test("initialize calls navigator.id.watch", function (assert) {
        var user = 'current user';
        var token = 'csrf token';
        var urls = {
            login: 'login url',
            logout: 'logout url'
        };
        var mockNavigator = {
            id: {
                watch: sinon.mock()
            }
        };
        Superlists.Accounts.initialize(mockNavigator, user, token, urls);
        assert.equal(
                mockNavigator.id.watch.calledOnce,
                true,
                'check watch function called'
        );
    });
    QUnit.test("watch sees current user", function (assert) {
        var user = 'current user';
        var token = 'csrf token';
        var urls = {
            login: 'login url',
            logout: 'logout url'
        };
        var mockNavigator = {
            id: {
                watch: sinon.mock()
            }
        };
        Superlists.Accounts.initialize(mockNavigator, user, token, urls);
        var watchCallArgs = mockNavigator.id.watch.firstCall.args[0];
        assert.equal(watchCallArgs.loggedInUser, user, 'check user');
    });
</script>
</body>
</html>